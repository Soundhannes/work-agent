<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Agent</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="top-section no-padding-top">
        <div class="header-bar">
            <h1 id="header-title">Work Agent</h1>
        </div>
        <div id="process-list"></div>
        <div id="process-detail" style="display:none"></div>
        <div id="menu-list" style="display:none"></div>
    </div>

    <div class="bottom-section">
        <input type="text" id="command-input" placeholder="Befehl eingeben..." autofocus>
    </div>

    <script>
        let selectedId = null;
        let processData = {};
        let currentUser = null;
        let allUsers = [];
        let menuOpen = false;
        let detailView = false;
        let currentProcess = null;

        async function loadProcesses() {
            const res = await fetch('/api/processes');
            const processes = await res.json();
            const list = document.getElementById('process-list');

            if (processes.length === 0) {
                list.innerHTML = '<div class="empty">Keine Vorgänge</div>';
                return;
            }

            processData = {};
            processes.forEach(p => processData[p.id] = p);

            const grouped = {offen: [], wartend: [], geschlossen: []};
            processes.forEach(p => {
                if (grouped[p.status]) grouped[p.status].push(p);
            });

            let html = '';
            ['offen', 'wartend', 'geschlossen'].forEach(status => {
                if (grouped[status].length > 0) {
                    html += '<div class="status-header">/' + status + '</div>';
                    grouped[status].forEach(p => {
                        const prio = p.priority === 'hoch' ? ' !!!' : (p.priority === 'normal' ? ' !!' : ' !');
                        const selected = p.id === selectedId ? ' selected' : '';
                        const assigned = p.assigned_first_name ? ' → ' + p.assigned_first_name : '';
                        html += '<div class="process-row' + selected + '" onclick="selectProcess(' + p.id + ')">' +
                            '<span class="title">' + p.title + prio + assigned + '</span>' +
                        '</div>';
                    });
                }
            });
            list.innerHTML = html;
        }

        async function loadUsers() {
            if (currentUser && currentUser.role === 'admin') {
                const res = await fetch('/api/users');
                allUsers = await res.json();
            }
        }

        function selectProcess(id) {
            const input = document.getElementById('command-input');
            if (selectedId === id) {
                selectedId = null;
                input.value = '';
            } else {
                selectedId = id;
                const p = processData[id];
                input.value = p.title + ' Priorität: ' + p.priority + ' Status: ' + p.status;
            }
            loadProcesses();
            input.focus();
        }

        async function showDetail(id) {
            const res = await fetch('/api/processes/' + id);
            currentProcess = await res.json();
            detailView = true;
            selectedId = id;

            document.getElementById('process-list').style.display = 'none';
            document.getElementById('process-detail').style.display = 'block';

            const p = currentProcess;
            const assigned = p.assigned_first_name ? p.assigned_first_name + ' ' + p.assigned_last_name : 'nicht zugewiesen';
            const prio = p.priority === 'hoch' ? 'Hoch' : (p.priority === 'normal' ? 'Normal' : 'Niedrig');
            const status = p.status.charAt(0).toUpperCase() + p.status.slice(1);

            let html = '<div class="detail-header">' + p.title + '</div>';
            html += '<div class="detail-info">';
            html += '<div class="detail-row"><span class="label">Status:</span> ' + status + '</div>';
            html += '<div class="detail-row"><span class="label">Priorität:</span> ' + prio + '</div>';
            html += '<div class="detail-row"><span class="label">Zugewiesen:</span> ' + assigned + '</div>';
            if (p.description) {
                html += '<div class="detail-row"><span class="label">Beschreibung:</span></div>';
                html += '<div class="detail-description">' + p.description + '</div>';
            }
            html += '</div>';

            // Sub-processes
            if (p.sub_processes && p.sub_processes.length > 0) {
                html += '<div class="status-header">/warten-auf</div>';
                p.sub_processes.forEach(sub => {
                    const subStatus = sub.status === 'geschlossen' ? ' ✓' : '';
                    const subAssigned = sub.assigned_first_name ? ' → ' + sub.assigned_first_name : '';
                    html += '<div class="process-row sub-process" onclick="showDetail(' + sub.id + ')">' +
                        '<span class="title">' + sub.title + subStatus + subAssigned + '</span>' +
                    '</div>';
                });
            }

            html += '<div class="detail-help">Befehle: warten: [Titel] | zuweisen: [Name] | notiz: [Text] | liste</div>';
            document.getElementById('process-detail').innerHTML = html;
            updateHeader(p.title);
        }

        function hideDetail() {
            detailView = false;
            currentProcess = null;
            selectedId = null;
            document.getElementById('process-detail').style.display = 'none';
            document.getElementById('process-list').style.display = 'block';
            loadProcesses();
            updateHeader('Vorgänge');
        }

        async function handleCommand(rawCmd) {
            const cmd = rawCmd.trim();
            const cmdLower = cmd.toLowerCase();
            if (!cmd) return;

            // Menu handling
            if (cmdLower === 'menü' || cmdLower === 'menu' || cmdLower === 'm') {
                if (detailView) hideDetail();
                showMenu();
                return;
            }
            if (menuOpen) {
                handleMenuChoice(cmd);
                return;
            }

            // Detail view commands
            if (detailView && currentProcess) {
                // Back to list
                if (cmdLower === 'liste' || cmdLower === 'l' || cmdLower === 'zurück') {
                    hideDetail();
                    return;
                }
                // Create sub-process
                if (cmdLower.startsWith('warten:') || cmdLower.startsWith('warten ') ||
                    cmdLower.startsWith('unter:') || cmdLower.startsWith('unter ')) {
                    const title = cmd.substring(cmd.indexOf(':') > 0 ? cmd.indexOf(':') + 1 : cmd.indexOf(' ') + 1).trim();
                    if (title) {
                        await fetch('/api/processes', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({title: title, parent_id: currentProcess.id, status: 'offen'})
                        });
                        showDetail(currentProcess.id);
                    }
                    return;
                }
                // Set description
                if (cmdLower.startsWith('notiz:') || cmdLower.startsWith('notiz ') ||
                    cmdLower.startsWith('beschreibung:') || cmdLower.startsWith('beschreibung ')) {
                    const sep = cmd.indexOf(':') > 0 ? cmd.indexOf(':') : cmd.indexOf(' ');
                    const desc = cmd.substring(sep + 1).trim();
                    await fetch('/api/processes/' + currentProcess.id, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({description: desc})
                    });
                    showDetail(currentProcess.id);
                    return;
                }
                // Assign
                if (cmdLower.startsWith('zuweisen:') || cmdLower.startsWith('zuweisen ') || cmdLower.startsWith('@')) {
                    const name = cmdLower.startsWith('@') ? cmd.substring(1).trim() : cmd.substring(cmd.indexOf(':') > 0 ? cmd.indexOf(':') + 1 : cmd.indexOf(' ') + 1).trim();
                    if (name === '' || name === 'niemand' || name === '-') {
                        await fetch('/api/processes/' + currentProcess.id, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({assigned_to: 0})
                        });
                    } else {
                        const user = allUsers.find(u =>
                            u.first_name.toLowerCase().includes(name.toLowerCase()) ||
                            u.last_name.toLowerCase().includes(name.toLowerCase())
                        );
                        if (user) {
                            await fetch('/api/processes/' + currentProcess.id, {
                                method: 'PUT',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({assigned_to: user.id})
                            });
                        }
                    }
                    showDetail(currentProcess.id);
                    return;
                }
                // Status/Priority changes work in detail too
            }

            // List view commands
            // Show detail
            if (selectedId && (cmdLower === 'details' || cmdLower === 'd' || cmdLower === 'öffnen')) {
                showDetail(selectedId);
                return;
            }

            // New process
            if (cmdLower.startsWith('neu:') || cmdLower.startsWith('neu ')) {
                const title = cmd.substring(4).trim();
                if (title) {
                    await fetch('/api/processes', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({title: title, priority: 'normal'})
                    });
                }
            }
            // Delete
            else if (selectedId && (cmdLower === 'löschen' || cmdLower === 'loeschen' || cmdLower === 'delete')) {
                await fetch('/api/processes/' + selectedId, {method: 'DELETE'});
                selectedId = null;
            }
            // Parse edited process
            else if (selectedId && (cmdLower.includes('priorität:') || cmdLower.includes('status:'))) {
                let title = cmd;
                let status = null;
                let priority = null;

                const prioMatch = cmdLower.match(/priorität:\s*(hoch|normal|niedrig)/);
                if (prioMatch) {
                    priority = prioMatch[1];
                    title = title.replace(/priorität:\s*(hoch|normal|niedrig)/i, '');
                }

                const statusMatch = cmdLower.match(/status:\s*(offen|wartend|geschlossen)/);
                if (statusMatch) {
                    status = statusMatch[1];
                    title = title.replace(/status:\s*(offen|wartend|geschlossen)/i, '');
                }

                title = title.trim();

                const update = {};
                if (status) update.status = status;
                if (priority) update.priority = priority;
                if (title && title !== processData[selectedId].title) update.title = title;

                if (Object.keys(update).length > 0) {
                    await fetch('/api/processes/' + selectedId, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(update)
                    });
                }
            }
            // Simple commands
            else if (selectedId) {
                const statusMap = {
                    'offen': 'offen',
                    'wartend': 'wartend', 'warten': 'wartend',
                    'geschlossen': 'geschlossen', 'erledigt': 'geschlossen', 'done': 'geschlossen'
                };
                const prioMap = {
                    'hoch': 'hoch', 'wichtig': 'hoch',
                    'normal': 'normal',
                    'niedrig': 'niedrig'
                };

                if (statusMap[cmdLower]) {
                    await fetch('/api/processes/' + selectedId, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({status: statusMap[cmdLower]})
                    });
                } else if (prioMap[cmdLower]) {
                    await fetch('/api/processes/' + selectedId, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({priority: prioMap[cmdLower]})
                    });
                }
            }

            if (!detailView) {
                selectedId = null;
                loadProcesses();
            }
        }

        document.getElementById('command-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleCommand(this.value);
                this.value = '';
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (menuOpen) {
                    hideMenu();
                } else if (detailView) {
                    hideDetail();
                } else if (selectedId) {
                    selectedId = null;
                    loadProcesses();
                }
                document.getElementById('command-input').value = '';
                document.getElementById('command-input').focus();
            }
        });

        loadProcesses();

        async function loadUser() {
            const res = await fetch('/api/me');
            if (res.ok) {
                currentUser = await res.json();
                updateHeader('Vorgänge');
                loadUsers();
            }
        }

        function updateHeader(pageName) {
            if (!currentUser) return;
            document.getElementById('header-title').innerHTML =
                '_' + currentUser.first_name + ' ' + currentUser.last_name + ' / Work Agent <span class="page-name">/ ' + pageName + '</span>';
        }

        function showMenu() {
            menuOpen = true;
            document.getElementById('process-list').style.display = 'none';
            document.getElementById('process-detail').style.display = 'none';
            document.getElementById('menu-list').style.display = 'block';

            let html = '<div class="menu-item">0 - Benutzer</div>';
            if (currentUser && currentUser.role === 'admin') {
                html += '<div class="menu-item">1 - Login-Log</div>';
            }
            html += '<div class="menu-item">9 - Logout</div>';
            document.getElementById('menu-list').innerHTML = html;
            updateHeader('Menü');
        }

        function hideMenu() {
            menuOpen = false;
            document.getElementById('menu-list').style.display = 'none';
            if (detailView && currentProcess) {
                document.getElementById('process-detail').style.display = 'block';
                updateHeader(currentProcess.title);
            } else {
                document.getElementById('process-list').style.display = 'block';
                updateHeader('Vorgänge');
            }
        }

        function handleMenuChoice(choice) {
            if (choice === '0') {
                window.location.href = '/users';
            } else if (choice === '1' && currentUser && currentUser.role === 'admin') {
                window.location.href = '/log';
            } else if (choice === '9') {
                logout();
            } else {
                hideMenu();
            }
        }

        async function logout() {
            await fetch('/api/logout', {method: 'POST'});
            window.location.href = '/login';
        }

        loadUser();
    </script>
</body>
</html>
